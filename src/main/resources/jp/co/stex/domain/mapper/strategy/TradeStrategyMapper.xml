<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="jp.co.stex.domain.mapper.strategy.TradeStrategyMapper">

  <resultMap id="tradeStrategyMap" type="TradeStrategy">
    <constructor>
      <idArg column="sid" name="sid" javaType="VSid" />
      <arg column="gid" name="gid" javaType="VGid" />
      <arg column="trade_strategy_name" name="tradeStrategyName" javaType="VTradeStrategyName" />
      <arg name="termOfAnalysis" resultMap="termOfAnalysisMap" />
      <arg column="analyzed_at" name="analyzedAt" javaType="VAnalyzedAt" />
      <arg column="memo" name="memo" javaType="VMemo" />
    </constructor>
  </resultMap>

  <resultMap id="termOfAnalysisMap" type="VTermOfAnalysis">
    <constructor>
      <arg column="analysis_start_date" name="analysisStartDate" javaType="java.time.LocalDate" />
      <arg column="analysis_end_date" name="analysisEndDate" javaType="java.time.LocalDate" />
    </constructor>
  </resultMap>

  <select id="findOne" resultMap="tradeStrategyMap">
    SELECT
      sid,
      uid,
      gid,
      trade_strategy_name,
      analysis_start_date,
      analysis_end_date,
      analyzed_at,
      memo
    FROM trade_strategies
    WHERE uid = #{uid}
    AND sid = #{sid}
  </select>

  <select id="findAll" resultMap="tradeStrategyMap">
    SELECT
      sid,
      uid,
      gid,
      trade_strategy_name,
      analysis_start_date,
      analysis_end_date,
      analyzed_at,
      memo
    FROM trade_strategies
    WHERE uid = #{uid}
    ORDER BY sid
  </select>

  <select id="createOne" resultType="VSid">
    INSERT INTO trade_strategies (
      sid,
      uid,
      gid,
      trade_strategy_name,
      analysis_start_date,
      analysis_end_date,
      memo
    )
    VALUES (
      #{tradeStrategy.sid},
      #{uid.uid},
      #{tradeStrategy.gid},
      #{tradeStrategy.tradeStrategyName},
      #{tradeStrategy.termOfAnalysis.analysisStartDate},
      #{tradeStrategy.termOfAnalysis.analysisEndDate},
      #{tradeStrategy.memo}
    )
    RETURNING sid
  </select>

  <update id="updateOne">
    UPDATE trade_strategies
    SET
      gid = #{tradeStrategy.gid},
      trade_strategy_name = #{tradeStrategy.tradeStrategyName},
      analysis_start_date = #{tradeStrategy.termOfAnalysis.analysisStartDate},
      analysis_end_date = #{tradeStrategy.termOfAnalysis.analysisEndDate},
      memo = #{tradeStrategy.memo}
    WHERE uid = #{uid}
    AND sid = #{tradeStrategy.sid}
  </update>

  <delete id="deleteOne">
    DELETE FROM trade_strategies
    WHERE
      uid = #{uid}
    AND
      sid = #{sid}
  </delete>
</mapper>
